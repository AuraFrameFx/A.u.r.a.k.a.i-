name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: PR title check
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const additions = files.reduce((sum, file) => sum + file.additions, 0);
            const deletions = files.reduce((sum, file) => sum + file.deletions, 0);
            const totalChanges = additions + deletions;
            const fileCount = files.length;

            console.log(`PR Stats: ${fileCount} files, +${additions}/-${deletions} lines`);

            if (totalChanges > 1000) {
              core.warning(`Large PR detected: ${totalChanges} lines changed across ${fileCount} files. Consider breaking it down.`);
            }

            if (fileCount > 50) {
              core.warning(`Many files changed: ${fileCount} files. Consider splitting into smaller PRs.`);
            }

  code-review-checks:
    name: Code Review Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for TODO/FIXME
        run: |
          if git diff origin/${{ github.base_ref }} | grep -E '^\+.*TODO|^\+.*FIXME'; then
            echo "::warning::New TODO or FIXME comments found in this PR"
          fi

      - name: Check for console.log (if applicable)
        run: |
          if git diff origin/${{ github.base_ref }} | grep -E '^\+.*println|^\+.*Log\.(v|d|i|w|e)' | grep -v '// OK:'; then
            echo "::notice::New log statements found. Ensure they're appropriate for production."
          fi
          continue-on-error: true

      - name: Check for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  build-size-check:
    name: Build Size Check
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Get APK size
        id: apk-size
        run: |
          APK_SIZE=$(stat -c%s app/build/outputs/apk/release/app-release-unsigned.apk || echo "0")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
          echo "size_bytes=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$APK_SIZE_MB" >> $GITHUB_OUTPUT

      - name: Comment APK size
        uses: actions/github-script@v7
        with:
          script: |
            const sizeMB = '${{ steps.apk-size.outputs.size_mb }}';

            const comment = `### üì¶ APK Size Report

            **Release APK Size:** ${sizeMB} MB

            ${parseFloat(sizeMB) > 50 ? '‚ö†Ô∏è APK size is quite large. Consider optimizing:
            - Enable ProGuard/R8 optimization
            - Use APK splits or AAB
            - Optimize resources and assets
            - Remove unused dependencies' : '‚úÖ APK size looks good!'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  danger-check:
    name: Danger Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Danger
        uses: danger/danger-js@13.0.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
